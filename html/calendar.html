<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='utf-8' />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RiSync Calendar</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales-all.min.js'></script>

  <style>
    :root { --primary-color: #f58220; --muted: #6b7280; }
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:#f3f6fb; margin:0; padding:18px; color:#111; }
    #main-container{ max-width:1100px; margin:0 auto; background:#fff; padding:18px; border-radius:12px; box-shadow:0 8px 30px rgba(14,20,40,0.06); }
    .header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px; flex-wrap:wrap; }
    h1{ margin:0; font-size:20px; color:var(--primary-color); }
    .controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    input[type="date"], button, input[type="text"]{ padding:8px 10px; border-radius:8px; border:1px solid #e6e9ef; font-size:14px; }
    button{ background:var(--primary-color); color:#fff; border:none; cursor:pointer; }
    .theme-buttons button{ width:30px; height:30px; border-radius:50%; border:2px solid #eee; cursor:pointer; }
    .modal{ display:none; position:fixed; z-index:60; inset:0; background:rgba(2,6,23,0.45); }
    .modal-content{ width:92%; max-width:720px; margin:6% auto; background:#fff; border-radius:12px; padding:16px; box-shadow:0 20px 50px rgba(2,6,23,0.18); }
    .modal-header{ display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #f1f4f8; padding-bottom:8px; }
    .close-btn{ cursor:pointer; font-size:22px; color:var(--muted); }
    .badge{ display:inline-block; padding:6px 10px; border-radius:999px; background:var(--primary-color); color:#fff; font-size:13px; }
    .weather-box{ margin-top:12px; padding:12px; border-radius:10px; background:#fbfdff; border:1px solid #eef6ff; }
    .events-list{ margin-top:10px; display:flex; flex-direction:column; gap:8px; }
    .event-row{ padding:10px; border-radius:8px; border:1px solid #f3f5f9; background:#fff; display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .event-title{ font-weight:600; }
    .muted{ color:var(--muted); font-size:13px; }
    @media (max-width:600px){ .header{ flex-direction:column; align-items:flex-start } }

    /* --- Meet options popup --- */
    .meet-options-popup {
      position: absolute;
      background: white;
      border: 1px solid #e6e9ef;
      box-shadow: 0 6px 18px rgba(10,20,40,0.08);
      padding: 8px;
      border-radius: 8px;
      display: none;
      z-index: 200;
      min-width: 180px;
    }
    .meet-options-popup button {
      display: block;
      width: 100%;
      padding: 8px 10px;
      margin: 4px 0;
      text-align: left;
      background: #fff;
      color: #111;
      border: 1px solid #f1f4f8;
      cursor: pointer;
      border-radius: 6px;
    }
    .meet-options-popup button:hover { background: #f8fafc; }
    .meet-btn-wrap { position: relative; display: inline-block; }
    .info-small { font-size: 12px; color: var(--muted); margin-top: 6px; }
  </style>
</head>
<body>
  <div id="main-container">
    <div class="header">
      <h1>RiSync Calendar</h1>
      <div class="controls">
        <a href="../index.html" class="logo">
          <img src="../assets/logo.png" alt="RiSync Logo" style="width:80px; height:auto;">
        </a>
        <input type="date" id="dateInput">
        <button id="goToDateBtn">Go to Date</button>
        <button id="addEventBtn">Add Event</button>
        <div class="theme-buttons" style="display:flex; gap:8px;">
          <button id="orangeTheme" style="background:#f58220"></button>
          <button id="blueTheme" style="background:#007bff"></button>
          <button id="greenTheme" style="background:#28a745"></button>
        </div>
      </div>
    </div>

    <div id='calendar'></div>
  </div>

  <!-- Add Event Modal -->
  <div id="addEventModal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="addEventTitle">
      <div class="modal-header">
        <h3 id="addEventTitle" style="margin:0">Add New Event</h3>
        <span class="close-btn" id="closeModalBtn" title="Close modal">&times;</span>
      </div>
      <div style="padding-top:10px;">
        <input id="eventName" placeholder="Event title" style="width:100%;margin-bottom:8px;">
        <input id="eventDate" type="date" style="width:100%;margin-bottom:8px;">
        <input id="googleMeetLink" placeholder="Google Meet link (optional)" style="width:100%;margin-bottom:8px;" readonly>

        <!-- Create Meet Link button with options popup -->
        <div class="meet-btn-wrap" style="margin-bottom:8px;">
          <button id="createMeetLinkBtn" style="background:#0ea5e9;">Create Meet Link</button>

          <div id="meetOptionsPopup" class="meet-options-popup" role="menu" aria-hidden="true">
            <button id="meetNowBtn" type="button">For now — start meeting now</button>
            <button id="meetLaterBtn" type="button">For later — create/copy link & paste</button>
          </div>
        </div>
        <div class="info-small">Tip: choose "For now" to immediately start a meet (opens meet.google.com/new). Choose "For later" to open the Meet homepage and paste the copied link here.</div>

        <div style="text-align:right; margin-top:12px;">
          <button id="saveEventBtn">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Day Details Modal (opens ONLY on date click) -->
  <div id="dayDetailsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="dayTitle" style="margin:0">Date Details</h3>
        <span class="close-btn" id="closeDayModal">&times;</span>
      </div>
      <div style="padding-top:10px;">
        <p><strong>Date:</strong> <span id="dayDate"></span></p>

        <div id="eventsContainer">
          <strong>Events</strong>
          <div class="events-list" id="eventsList"></div>
        </div>

        <div id="noEventsMsg" class="muted" style="display:none; margin-top:8px;">No events on this date.</div>

        <div id="weatherBox" class="weather-box" style="display:none;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <strong>Current weather</strong>
            <span class="muted" id="weatherUpdated"></span>
          </div>
          <p id="weatherText" style="margin:6px 0 0 0;"></p>

          <div id="forecastForDate" style="margin-top:12px;">
            <strong>Forecast for this date</strong>
            <p id="forecastText" class="muted" style="margin-top:6px;"></p>
          </div>
        </div>

        <div id="noWeatherMsg" class="muted" style="margin-top:8px; display:none;">Weather not available.</div>

        <div style="text-align:right;margin-top:12px;">
          <button id="closeDayFooter" style="background:#eef2ff;color:#111;padding:8px 12px;border-radius:8px;border:1px solid #e6e9ef;">Close</button>
        </div>
      </div>
    </div>
  </div>

  <button id="backButton" onclick="window.location.href='content.html'">← Back</button>

<script>
/* ---------- CONFIG ---------- */
const FALLBACK_COORDS = { lat: 28.6139, lon: 77.2090 };
const PRETTY = {0:'Clear',1:'Mainly clear',2:'Partly cloudy',3:'Overcast',45:'Fog',48:'Depositing rime fog',51:'Light drizzle',53:'Moderate drizzle',55:'Dense drizzle',56:'Light freezing drizzle',57:'Dense freezing drizzle',61:'Light rain',63:'Moderate rain',65:'Heavy rain',66:'Light freezing rain',67:'Heavy freezing rain',71:'Light snow',73:'Moderate snow',75:'Heavy snow',77:'Snow grains',80:'Slight rain showers',81:'Moderate rain showers',82:'Violent rain showers',85:'Slight snow showers',86:'Heavy snow showers',95:'Thunderstorm',96:'Thunderstorm slight hail',99:'Thunderstorm heavy hail' };

/* ---------- FIXED-DATE FESTIVALS ---------- */
/*
  Add here all festivals that HAVE a fixed month/day.
  These will be auto-generated for any year you view.
  Format: { title, month (1-12), day (1-31), color, description, isFestival:true }
*/
const fixedFestivals = [
  { title: "New Year's Day", month:1, day:1, color:'#f58220', description: "New Year", isFestival:true },
  { title: "Makar Sankranti", month:1, day:14, color:'#f58220', description: "Makar Sankranti", isFestival:true },
  { title: "Republic Day", month:1, day:26, color:'#f58220', description: "Republic Day (India)", isFestival:true },
  { title: "Valentine's Day", month:2, day:14, color:'#ff6b6b', description: "Valentine's Day", isFestival:false },
  { title: "Labour Day", month:5, day:1, color:'#f58220', description: "International Workers' Day", isFestival:false },
  { title: "Independence Day", month:8, day:15, color:'#f58220', description: "India Independence Day", isFestival:true },
  { title: "Gandhi Jayanti", month:10, day:2, color:'#f58220', description: "Gandhi Jayanti", isFestival:true },
  { title: "Christmas", month:12, day:25, color:'#f58220', description: "Christmas Day", isFestival:true },
  { title: "Guru Nanak Jayanti (fixed placeholder)", month:11, day:15, color:'#f58220', description: "Often varies — placeholder if needed", isFestival:true }
  // Note: many Indian festivals (Diwali, Holi, Eid, Janmashtami, etc.) follow lunar/calendar rules and are variable.
];

/* ---------- PREDEFINED / ONE-OFF EVENTS (kept for historical 2024 entries) ---------- */
const predefinedEvents = [
  { title: "New Year's Day", start: "2024-01-01", color: "#f58220", description: "Happy New Year!", isFestival: true },
  { title: "Makar Sankranti", start: "2024-01-14", color: "#f58220", description: "A Hindu festival dedicated to the deity Surya.", isFestival: true },
  { title: "Republic Day", start: "2024-01-26", color: "#f58220", description: "Celebrates the date the Constitution of India came into force.", isFestival: false },
  { title: "Vasant Panchami", start: "2024-02-14", color: "#f58220", description: "A festival marking the arrival of spring.", isFestival: true },
  { title: "Holi (2024)", start: "2024-03-25", color: "#f58220", description: "Festival of colors (date varies by year).", isFestival: true },
  { title: "Good Friday", start: "2024-03-29", color: "#f58220", description: "A Christian holiday.", isFestival: false },
  { title: "Ram Navami (2024)", start: "2024-04-17", color: "#f58220", description: "Date varies each year.", isFestival: true },
  { title: "Independence Day", start: "2024-08-15", color: "#f58220", description: "India Independence Day", isFestival: true },
  { title: "Gandhi Jayanti", start: "2024-10-02", color: "#f58220", description: "Gandhi Jayanti", isFestival: true },
  { title: "Diwali (2024)", start: "2024-11-01", color: "#f58220", description: "Diwali (date varies by year)", isFestival: true },
  { title: "Christmas", start: "2024-12-25", color: "#f58220", description: "Christmas Day", isFestival: true }
];

const savedEvents = JSON.parse(localStorage.getItem('calendarEvents')) || [];
let allEvents = [...predefinedEvents, ...savedEvents];

let monthCache = JSON.parse(localStorage.getItem('monthForecastCache') || '{}');

// Keep track of which years we've generated fixed festivals for so we don't duplicate
const generatedFixedFestivalsForYear = JSON.parse(localStorage.getItem('generatedFixedFestivalsForYear') || '{}');

document.addEventListener('DOMContentLoaded', async () => {
  const calendarEl = document.getElementById('calendar');
  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    headerToolbar: { left: 'prev,next today', center: 'title', right: 'customYearSelect' },
    customButtons: {
      customYearSelect: {
        text: 'Select Year',
        click: function() {
          let year = prompt("Enter a year:");
          if (year) calendar.gotoDate(new Date(year, calendar.getDate().getMonth(), 1));
        }
      }
    },
    events: allEvents,
    dateClick: function(info) {
      openDayDetailsModal(info.dateStr);
    },
    eventClick: function(info) {
      info.jsEvent.preventDefault();
    },
    // when the calendar changes (month/year), ensure fixed festivals are generated
    datesSet: async function(info) {
      const visibleYear = info.start.getFullYear();
      // generate for visibleYear and neighbor years so when user flips months it's already there
      await ensureFixedFestivalsForYear(visibleYear - 1);
      await ensureFixedFestivalsForYear(visibleYear);
      await ensureFixedFestivalsForYear(visibleYear + 1);

      // also ensure monthly forecast (existing behavior)
      const monthStart = new Date(info.start.getFullYear(), info.start.getMonth(), 1);
      await ensureMonthForecast(monthStart.getFullYear(), monthStart.getMonth()+1);
    },
    eventDidMount: function(info) {
      if (info.el.querySelector('.fc-event-title')) {
        const desc = info.event.extendedProps.description || '';
        info.el.querySelector('.fc-event-title').setAttribute('title', desc);
      }
    }
  });

  calendar.render();

  // controls
  document.getElementById('goToDateBtn').addEventListener('click', () => {
    const v = document.getElementById('dateInput').value;
    if (v) calendar.gotoDate(v);
  });

  document.getElementById('orangeTheme').addEventListener('click', ()=> setTheme('#f58220'));
  document.getElementById('blueTheme').addEventListener('click', ()=> setTheme('#007bff'));
  document.getElementById('greenTheme').addEventListener('click', ()=> setTheme('#28a745'));

  function setTheme(color) {
    document.documentElement.style.setProperty('--primary-color', color);
    calendar.getEvents().forEach(ev => {
      if (['#f58220','#007bff','#28a745'].includes(ev.backgroundColor || ev.extendedProps.color)) {
        ev.setProp('backgroundColor', color);
      }
    });
  }

  // add event UI
  const addEventBtn = document.getElementById('addEventBtn');
  const addEventModal = document.getElementById('addEventModal');
  const closeModalBtn = document.getElementById('closeModalBtn');
  const saveEventBtn = document.getElementById('saveEventBtn');
  const eventNameInput = document.getElementById('eventName');
  const eventDateInput = document.getElementById('eventDate');
  const googleMeetLinkInput = document.getElementById('googleMeetLink');

  // Meet UI elements
  const createMeetLinkBtn = document.getElementById('createMeetLinkBtn');
  const meetOptionsPopup = document.getElementById('meetOptionsPopup');
  const meetNowBtn = document.getElementById('meetNowBtn');
  const meetLaterBtn = document.getElementById('meetLaterBtn');

  // Build button interactions
  addEventBtn.addEventListener('click', ()=> {
    addEventModal.style.display='block';
    addEventModal.setAttribute('aria-hidden','false');
    // reset inputs
    eventNameInput.value = '';
    eventDateInput.value = '';
    googleMeetLinkInput.value = '';
    googleMeetLinkInput.readOnly = true;
  });
  closeModalBtn.addEventListener('click', closeAddModal);
  window.addEventListener('click', (e)=> { if (e.target == addEventModal) closeAddModal(); });

  function closeAddModal(){ addEventModal.style.display='none'; addEventModal.setAttribute('aria-hidden','true'); eventNameInput.value=''; eventDateInput.value=''; googleMeetLinkInput.value=''; meetOptionsPopup.style.display='none'; }

  saveEventBtn.addEventListener('click', ()=> {
    const name = eventNameInput.value.trim();
    const date = eventDateInput.value;
    const meet = googleMeetLinkInput.value.trim();
    if (!name || !date) return alert('Fill title + date');
    const newEvent = { title: name, start: date, color:'purple', description:'Custom event', googleMeetLink: meet, isFestival:false };
    calendar.addEvent(newEvent);
    savedEvents.push(newEvent);
    localStorage.setItem('calendarEvents', JSON.stringify(savedEvents));
    closeAddModal();
  });

  /* ---------- MEET BUTTON LOGIC ---------- */

  // Position popup under createMeetLinkBtn and toggle display
  createMeetLinkBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    // toggle visibility
    if (meetOptionsPopup.style.display === 'block') {
      meetOptionsPopup.style.display = 'none';
      meetOptionsPopup.setAttribute('aria-hidden','true');
      return;
    }
    // compute position relative to wrapper
    const rect = createMeetLinkBtn.getBoundingClientRect();
    meetOptionsPopup.style.display = 'block';
    meetOptionsPopup.style.left = (createMeetLinkBtn.offsetLeft) + 'px';
    meetOptionsPopup.style.top = (createMeetLinkBtn.offsetTop + createMeetLinkBtn.offsetHeight + 6) + 'px';
    meetOptionsPopup.setAttribute('aria-hidden','false');
  });

  // hide popup on outside click
  document.addEventListener('click', (ev) => {
    if (!meetOptionsPopup.contains(ev.target) && ev.target !== createMeetLinkBtn) {
      meetOptionsPopup.style.display = 'none';
      meetOptionsPopup.setAttribute('aria-hidden','true');
    }
  });

  // For now: set date to today, set meet link to meet.new, open new tab
  meetNowBtn.addEventListener('click', () => {
    try {
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const dd = String(now.getDate()).padStart(2, '0');
      eventDateInput.value = `${yyyy}-${mm}-${dd}`;
      googleMeetLinkInput.value = 'https://meet.google.com/new';
      googleMeetLinkInput.readOnly = true;
      // close popup
      meetOptionsPopup.style.display = 'none';
      meetOptionsPopup.setAttribute('aria-hidden','true');
      // open meet.new to start meeting immediately
      window.open('https://meet.google.com/new', '_blank');
    } catch (err) {
      console.error('meetNow err', err);
      alert('Could not open Meet. Please try again.');
    }
  });

  // For later: open meet home, allow pasting the link
  meetLaterBtn.addEventListener('click', () => {
    try {
      googleMeetLinkInput.value = '';
      googleMeetLinkInput.readOnly = false; // allow paste
      googleMeetLinkInput.focus();
      // close popup
      meetOptionsPopup.style.display = 'none';
      meetOptionsPopup.setAttribute('aria-hidden','true');
      // open meet homepage in new tab — user can create or copy a link
      window.open('https://meet.google.com/', '_blank');
      alert('Meet homepage opened in new tab. Copy the meeting link and paste it into the "Google Meet link" field.');
    } catch (err) {
      console.error('meetLater err', err);
      alert('Could not open Meet. Please try again.');
    }
  });

  /* ---------- Day Details modal logic ---------- */
  const dayModal = document.getElementById('dayDetailsModal');
  const closeDayModal = document.getElementById('closeDayModal');
  const closeDayFooter = document.getElementById('closeDayFooter');

  closeDayModal.addEventListener('click', ()=> dayModal.style.display='none');
  closeDayFooter.addEventListener('click', ()=> dayModal.style.display='none');
  window.addEventListener('click', (e)=> { if (e.target == dayModal) dayModal.style.display='none'; });

  async function openDayDetailsModal(dateStr) {
    document.getElementById('dayTitle').textContent = `Details — ${dateStr}`;
    document.getElementById('dayDate').textContent = dateStr;

    const eventsListEl = document.getElementById('eventsList');
    eventsListEl.innerHTML = '';
    const eventsOnDate = allEvents.filter(ev => ev.start === dateStr);
    if (eventsOnDate.length === 0) {
      document.getElementById('eventsContainer').style.display = 'none';
      document.getElementById('noEventsMsg').style.display = 'block';
    } else {
      document.getElementById('eventsContainer').style.display = 'block';
      document.getElementById('noEventsMsg').style.display = 'none';
      eventsOnDate.forEach(ev => {
        const row = document.createElement('div');
        row.className = 'event-row';
        const left = document.createElement('div');
        left.innerHTML = `<div class="event-title">${ev.title}</div><div class="muted">${ev.description || ''}</div>`;
        const right = document.createElement('div');
        right.style.textAlign = 'right';
        const typeBadge = ev.isFestival || isEventFestival(ev) ? '<span class="badge">Festival</span>' : '';
        const meetLink = ev.googleMeetLink ? `<div style="margin-top:6px"><a href="${ev.googleMeetLink}" target="_blank">Join Meet</a></div>` : '';
        right.innerHTML = `${typeBadge}${meetLink}`;
        row.appendChild(left);
        row.appendChild(right);
        eventsListEl.appendChild(row);
      });
    }

    // weather (unchanged)
    document.getElementById('weatherBox').style.display='block';
    document.getElementById('weatherText').textContent = 'Fetching current weather...';
    document.getElementById('weatherUpdated').textContent = '';
    document.getElementById('forecastText').textContent = '';

    const coords = await getUserCoords();
    try {
      const cur = await fetchCurrentWeatherOpenMeteo(coords.lat, coords.lon);
      const curDesc = PRETTY[cur.weathercode] || cur.weathercode;
      const updatedAt = (new Date()).toLocaleString();
      document.getElementById('weatherText').innerHTML = `${curDesc}. Temp ${cur.temperature}°C, wind ${cur.windspeed} m/s.`;
      document.getElementById('weatherUpdated').textContent = `as of ${updatedAt}`;

      const evDate = new Date(dateStr);
      const monthKey = `${evDate.getFullYear()}-${String(evDate.getMonth()+1).padStart(2,'0')}`;
      await ensureMonthForecast(evDate.getFullYear(), evDate.getMonth()+1);
      const monthObj = monthCache[monthKey];
      if (monthObj && monthObj.data && monthObj.data[dateStr]) {
        const info = monthObj.data[dateStr];
        const pretty = PRETTY[info.weathercode] || info.weathercode;
        document.getElementById('forecastText').textContent = `${pretty} — High ${info.maxTemp}°C, Low ${info.minTemp}°C.`;
      } else {
        const single = await fetchForecastForDate(coords.lat, coords.lon, dateStr);
        if (single) {
          const pretty = PRETTY[single.weathercode] || single.weathercode;
          document.getElementById('forecastText').textContent = `${pretty} — High ${single.maxTemp}°C, Low ${single.minTemp}°C.`;
        } else {
          document.getElementById('forecastText').textContent = 'Forecast not available for this date.';
        }
      }

      document.getElementById('noWeatherMsg').style.display='none';
    } catch (err) {
      console.error('weather fail', err);
      document.getElementById('weatherBox').style.display='none';
      document.getElementById('noWeatherMsg').style.display='block';
    }

    dayModal.style.display='block';
  }

  function isEventFestival(event) {
    const keys = ['diwali','holi','eid','shiva','ganesh','navami','muharram','purnima','janmashtami','raksha','makar','buddha','christmas','guru','mahavir','dussehra','new year','sankranti','republic','independence','gandhi'];
    const t = (event.title||'').toLowerCase();
    return keys.some(x=> t.includes(x));
  }

  /* ---------- Fixed festival generator ---------- */

  // generate fixed festivals for a given year (if not already generated)
  async function ensureFixedFestivalsForYear(year) {
    if (generatedFixedFestivalsForYear[year]) return; // already done
    // create events from fixedFestivals array for the given year
    const eventsToAdd = fixedFestivals.map(f => {
      const mm = String(f.month).padStart(2,'0');
      const dd = String(f.day).padStart(2,'0');
      return {
        title: f.title,
        start: `${year}-${mm}-${dd}`,
        color: f.color || '#f58220',
        description: f.description || '',
        isFestival: f.isFestival || true,
        _generatedFixedFestival: true // internal marker
      };
    });

    // push into allEvents and into calendar
    eventsToAdd.forEach(ev => {
      allEvents.push(ev);
      // find calendar and add event
      try {
        const cal = FullCalendar.getCalendar(document.getElementById('calendar'));
        if (cal) cal.addEvent(ev);
      } catch (err) {
        // fallback: ignore
        console.warn('Could not add event to calendar directly', err);
      }
    });

    generatedFixedFestivalsForYear[year] = true;
    // persist minimal record so it survives reload
    localStorage.setItem('generatedFixedFestivalsForYear', JSON.stringify(generatedFixedFestivalsForYear));
  }

  /* ---------- Geolocation + Open-Meteo helpers (same as before) ---------- */
  function getUserCoords() {
    return new Promise((resolve) => {
      if (!navigator.geolocation) return resolve(FALLBACK_COORDS);
      navigator.geolocation.getCurrentPosition(
        pos => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
        err => { console.warn('geo fail, fallback', err); resolve(FALLBACK_COORDS); },
        { timeout:8000 }
      );
    });
  }

  async function fetchCurrentWeatherOpenMeteo(lat, lon) {
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=auto`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('Open-Meteo current failed');
    const j = await res.json();
    return { temperature: j.current_weather.temperature, windspeed: j.current_weather.windspeed, weathercode: j.current_weather.weathercode, timezone: j.timezone || '' };
  }

  async function fetchForecastForDate(lat, lon, dateStr) {
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min,weathercode&timezone=auto&start_date=${dateStr}&end_date=${dateStr}`;
    const res = await fetch(url);
    if (!res.ok) return null;
    const j = await res.json();
    if (!j.daily || !j.daily.time || j.daily.time.length===0) return null;
    return { maxTemp: j.daily.temperature_2m_max[0], minTemp: j.daily.temperature_2m_min[0], weathercode: j.daily.weathercode ? j.daily.weathercode[0] : null };
  }

  async function ensureMonthForecast(year, month1indexed) {
    const key = `${year}-${String(month1indexed).padStart(2,'0')}`;
    const cached = monthCache[key];
    if (cached && (Date.now() - cached.fetchedAt < 1000*60*60*12)) return;
    const start = `${year}-${String(month1indexed).padStart(2,'0')}-01`;
    const endDate = new Date(year, month1indexed, 0).getDate();
    const end = `${year}-${String(month1indexed).padStart(2,'0')}-${String(endDate).padStart(2,'0')}`;
    const coords = await getUserCoords();
    try {
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&daily=temperature_2m_max,temperature_2m_min,weathercode&timezone=auto&start_date=${start}&end_date=${end}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('month forecast fetch failed');
      const j = await res.json();
      const map = {};
      if (j && j.daily && j.daily.time && j.daily.time.length) {
        for (let i=0;i<j.daily.time.length;i++){
          const day = j.daily.time[i];
          map[day] = { maxTemp: j.daily.temperature_2m_max[i], minTemp: j.daily.temperature_2m_min[i], weathercode: j.daily.weathercode ? j.daily.weathercode[i] : null };
        }
      }
      monthCache[key] = { fetchedAt: Date.now(), data: map };
      monthCache = trimMonthCache(monthCache, 6);
      localStorage.setItem('monthForecastCache', JSON.stringify(monthCache));
    } catch (err) {
      console.warn('ensureMonthForecast err', err);
    }
  }

  function trimMonthCache(cacheObj, keepMonths) {
    const keys = Object.keys(cacheObj).sort().reverse();
    const keep = keys.slice(0, keepMonths);
    const out = {};
    for (const k of keep) out[k] = cacheObj[k];
    return out;
  }

}); // DOMContentLoaded end
</script>
</body>
</html>
